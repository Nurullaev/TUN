#!/bin/bash
# ะััะฐะฝะพะฒะธัั ัะบัะธะฟั ะฝะตะผะตะดะปะตะฝะฝะพ, ะตัะปะธ ะปัะฑะฐั ะบะพะผะฐะฝะดะฐ ะทะฐะฒะตััะธััั ั ะพัะธะฑะบะพะน.
set -e

# --- ะะตัะตะผะตะฝะฝัะต ะดะปั ัะดะพะฑััะฒะฐ ---
VENV_DIR=".venv"
# !!! ะะะะะะะ ะะะะะะะะะ: ะฃะบะฐะทัะฒะฐะตะผ ะฟัะฐะฒะธะปัะฝะพะต ะธะผั ัะฐะนะปะฐ !!!
MAIN_PYTHON_FILE="vk-tun.py"

# --- ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ะบัะฐัะธะฒัั ะทะฐะณะพะปะพะฒะบะพะฒ ---
print_header() {
    echo ""
    echo "================================================================="
    echo " $1"
    echo "================================================================="
    sleep 1
}

# --- ะจะะ 1: ะะะกะขะะะะะ ะะะะฃะะะะะฏ ---
print_header "โ๏ธ  ะจะะ 1: ะะฐัััะพะนะบะฐ ะพะบััะถะตะฝะธั"

if [ ! -d "$VENV_DIR" ]; then
    echo "๐ ะกะพะทะดะฐั ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต Python ะฒ '$VENV_DIR'..."
    python3 -m venv "$VENV_DIR"
fi

echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะฝะตะพะฑัะพะดะธะผัะต Python-ะทะฐะฒะธัะธะผะพััะธ..."
# ะฏะะะ ะธัะฟะพะปัะทัะตะผ pip ะธะท ะฝะฐัะตะณะพ venv ะธ ะะะะะะซะะะะ ะะซะะะ.
"$VENV_DIR/bin/pip" install aiohttp pycryptodome websockets
echo "โ Python-ะทะฐะฒะธัะธะผะพััะธ ััะฟะตัะฝะพ ัััะฐะฝะพะฒะปะตะฝั."

echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐั npm-ะฟะฐะบะตั '@vkontakte/vk-tunnel'..."
npm i -g @vkontakte/vk-tunnel
echo "โ npm-ะฟะฐะบะตั ัััะฐะฝะพะฒะปะตะฝ."


# --- ะจะะ 2: ะะะกะขะะะะะ ะะะะคะะะฃะะะฆะะะะะะะ ะคะะะะ ---
print_header "โ๏ธ  ะจะะ 2: ะะฐัััะพะนะบะฐ ะบะพะฝัะธะณััะฐัะธะพะฝะฝะพะณะพ ัะฐะนะปะฐ"

# ะัะพะฒะตััะตะผ, ััะพ ะฝะฐั ะณะปะฐะฒะฝัะน ัะฐะนะป ัััะตััะฒัะตั
if [ ! -f "$MAIN_PYTHON_FILE" ]; then
    echo "โ ะัะธะฑะบะฐ: ะะปะฐะฒะฝัะน ัะฐะนะป '$MAIN_PYTHON_FILE' ะฝะต ะฝะฐะนะดะตะฝ. ะะต ะผะพะณั ะฟัะพะดะพะปะถะธัั."
    exit 1
fi

# --- ะกะฝะฐัะฐะปะฐ ะทะฐะฟัะฐัะธะฒะฐะตะผ ะฒัะต ะดะฐะฝะฝัะต ั ะฟะพะปัะทะพะฒะฐัะตะปั ---
echo ""
echo "ะะพะถะฐะปัะนััะฐ, ะฒะฒะตะดะธัะต ะดะฐะฝะฝัะต ะดะปั Telegram (ะพะฝะธ ะฑัะดัั ะทะฐะฟะธัะฐะฝั ะฒ $MAIN_PYTHON_FILE):"
read -p "   - Telegram BOT_TOKEN: " BOT_TOKEN
read -p "   - Telegram CHAT_ID: " CHAT_ID
read -p "   - ะะฐั ะปะธัะฝัะน Telegram User ID (ะดะปั ะบะพะผะฐะฝะดั /restart-tunnel): " ALLOWED_USER_ID

# --- ะะฐะฟะธััะฒะฐะตะผ ะดะฐะฝะฝัะต ะฒ vk-tun.py ---
echo "โ๏ธ  ะะฑะฝะพะฒะปัั ัะฐะนะป '$MAIN_PYTHON_FILE'..."
# ะัะฟะพะปัะทัะตะผ ะฝะฐะดะตะถะฝัะต ะบะพะผะฐะฝะดั sed, ะบะพัะพััะต ะทะฐะผะตะฝัั ะทะฝะฐัะตะฝะธั, ะดะฐะถะต ะตัะปะธ ะพะฝะธ ัะถะต ะฑัะปะธ ัััะฐะฝะพะฒะปะตะฝั
sed -i.bak \
    -e "s/BOT_TOKEN = \".*\"/BOT_TOKEN = \"$BOT_TOKEN\"/" \
    -e "s/CHAT_ID = \".*\"/CHAT_ID = \"$CHAT_ID\"/" \
    -e "s/ALLOWED_USER_ID = .*/ALLOWED_USER_ID = $ALLOWED_USER_ID/" \
    "$MAIN_PYTHON_FILE"

echo "โ ะคะฐะนะป '$MAIN_PYTHON_FILE' ััะฟะตัะฝะพ ะฝะฐัััะพะตะฝ."


# --- ะจะะ 3: ะะะะฃะกะ ะะะะะะะะะะฏ ---
print_header "๐ ะจะะ 3: ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั"
read -p "ะฅะพัะธัะต ะทะฐะฟัััะธัั ัะตัะฒะตั ัะตะนัะฐั ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต? (y/n) " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "โณ ะะฐะฟััะบะฐั $MAIN_PYTHON_FILE..."
    
    # ะฏะะะ ะธัะฟะพะปัะทัะตะผ python3 ะธะท ะฝะฐัะตะณะพ venv
    nohup "$VENV_DIR/bin/python3" "$MAIN_PYTHON_FILE" > server.log 2>&1 &
    
    sleep 2 # ะะฐะตะผ ะฟัะพัะตััั ะฒัะตะผั ะทะฐะฟัััะธัััั

    if ps -p $! > /dev/null; then
        echo "โ ะัะพัะตัั '$MAIN_PYTHON_FILE' ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ."
        echo "   - ะะพะณะธ ะผะพะถะฝะพ ะฟะพัะผะพััะตัั ะบะพะผะฐะฝะดะพะน: tail -f server.log"
    else
        echo "โ ะัะธะฑะบะฐ ะฟัะธ ะทะฐะฟััะบะต '$MAIN_PYTHON_FILE'. ะัะพะฒะตัััะต ะปะพะณ 'server.log'."
    fi
else
    echo "โน๏ธ  ะะฐะฟััะบ ะพัะผะตะฝะตะฝ. ะั ะผะพะถะตัะต ะทะฐะฟัััะธัั ัะบัะธะฟั ะฟะพะทะถะต ะบะพะผะฐะฝะดะพะน:"
    echo "   nohup ./.venv/bin/python3 $MAIN_PYTHON_FILE > server.log 2>&1 &"
fi

echo ""
echo "๐ ะะฐัััะพะนะบะฐ ะทะฐะฒะตััะตะฝะฐ!"